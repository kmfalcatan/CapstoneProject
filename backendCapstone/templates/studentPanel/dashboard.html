{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Panel</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="{% static 'css/popUpMessage.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Open+Sans:wght@400;500;700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">

    <style>
        *{
            padding: 0;
            margin: 0;
            font-family: "Roboto", sans-serif;
        }
    </style>
    <style>
        
    /*Cellphone*/
    @media only screen and (max-width: 600px){
        .subInstructionContainer{
            font-size: 0.8rem;
            padding: 0 0.5rem 0 0.5rem;
        }

        .text7{
            display: none;
        }

        .subCourseInfoContainer{
            width: 90%;
        }
    }
input[type="text"]::placeholder {
    color: rgb(72,72,72);
}

.submitButton{
    background-color: rgb(207,207,207); 
    color: rgb(72,72,72);
    box-shadow: none;
}


.submitButton:hover{
    color: rgb(72,72,72);
    background-color: rgb(207,207,207);
    border: solid rgb(72,72,72) 1px;
    transform: scale(1.05);
}
    </style>
</head>
<body style="background-color: rgb(240,240,240);">
    <div class="container" style="background-color: rgb(240,240,240);">
        <div class="headerContainer">
            <div class='menubarContainer' onclick='toggleMenu(this)'>
                <div class='line' style="border: solid rgb(72,72,72) 2px;"></div>
                <div class='line' style="border: solid rgb(72,72,72) 2px;"></div>
                <div class='line' style="border: solid rgb(72,72,72) 2px;"></div>
            </div>
        </div>

        <div style="background-color: rgb(240,240,240);" class="subMenubarContainer">
            <a href="{% url 'logout' %}">
                <div class="barContainer">
                    <p>Back</p>
                </div>
            </a>

            <div onclick="feedback()" class="barContainer1">
                <p>Feedback</p>
            </div>
        </div>

        <div class="textContainer" style="height: 3rem;">
            <p style="color: rgb(72,72,72);">Enter your grades and CET result</p>
        </div>

        <form method="POST" action="{% url 'dashboard' %}" id="gradesForm">
            {% csrf_token %}
            <div class="inputContainer">
                <div class="gradesContainer" style="flex-direction: column;">
                    <p style="width: 20rem; justify-content: left;">Enter Your SHS Average Grade:</p>
                    <input style="color: rgb(72,72,72); box-shadow: none; margin-top: 0.5rem; border: solid rgb(72,72,72) 1px; background-color: rgb(207,207,207); "
                           class="grades" name="avg_grade" type="number" step="0.01" required>
                </div>

                <div class="gradesContainer" style="flex-direction: column;">
                    <p style="width: 20rem; justify-content: left;">Enter Your CET Overall Percentage:</p>
                    <input style="color: rgb(72,72,72); box-shadow: none; margin-top: 0.5rem; border: solid rgb(72,72,72) 1px; background-color: rgb(207,207,207); "
                           class="grades" name="avg_cet" type="number" step="0.01" required>
                </div>
            </div>

            <div class="instructionContainer">
                <div class="subInstructionContainer">
                    <p>1.Strongly disagree | 2.Disagree | 3.Agree | 4.Strongly agree</p>
                </div>
            </div>

            <div class="questionContainer" style="gap: 0.5rem;">
                <input type="hidden" name="studentID" value="{{ request.session.student_id }}">

                {% for question in questions %}
                <div class="subQuestionContainer" style="box-shadow: 0 0 10px rgb(187, 185, 1850); padding: 1rem; width: 89%; border-radius: 0.5rem;">
                    <div class="question" style="text-align: left; width: 100%; justify-content: left;">
                        <p style="color: rgb(72,72,72); font-weight: bold; font-size: 2rem;">
                            {{ forloop.counter }}. {{ question.text }}
                        </p>
                        <input type="hidden" name="questions_{{ forloop.counter }}" value="{{ question.text }}">
                    </div>

                    {% if question.courses %}
                    <div class="coursesList" style="display: none;">
                        <p><strong>Courses:</strong> {{ question.courses|join:", " }}</p>
                    </div>
                    {% endif %}

                    <div class="choiceContainer">
                        <div class="subChoiceContainer" style="gap: 4rem;">
                            <label for="" style="color: black; display: flex; gap: 0.2rem;">1<input class="answer" type="radio" name="response_{{ forloop.counter }}" value="0.25" required></label>
                            <label for="" style="color: black; display: flex; gap: 0.2rem;">2<input class="answer" type="radio" name="response_{{ forloop.counter }}" value="0.50"></label>
                            <label for="" style="color: black; display: flex; gap: 0.2rem;">3<input class="answer" type="radio" name="response_{{ forloop.counter }}" value="0.75"></label>
                            <label for="" style="color: black; display: flex; gap: 0.2rem;">4<input class="answer" type="radio" name="response_{{ forloop.counter }}" value="1"></label>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <p style="text-align: center;">The questions above is adapted on "Career Aptitude Test" and is used with full acknowledgement of their copyright and ownership link:<a href="https://www.truity.com/test/career-personality-profiler-test">https://www.truity.com/test/career-personality-profiler-test</a></p>

                <div class="submitContainer" style="display: none;">
                    <button type="submit" class="submitButton" onclick="showPopup()">Done</button>
                </div>
            </div>
        </form>                                             
    </div>   

    <div class="courseInfoContainer" style="display: none;">
        <div class="courseInfoContainer" style="background-color: none;">
            <div class="subCourseInfoContainer">
                <div class="closeContainer">
                    <div class="subCloseContainer">
                        <img onclick="feedback()" class="closeButton" src="{% static 'img/Screenshot 2024-07-17 221356.png' %}" alt="">
                    </div>

                    <div style="
                    width: 19.6rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.6rem;
                    font-weight: bold;
                    padding-right: 2.5rem;">
                        <p>Feedback</p>
                    </div>
                </div>

                <div class="courseName">
                    <input style="text-align: left; padding-left: 0.5rem;" type="text" class="subCourseName" id="feedbackName" placeholder="Enter your name:" required>

                    <textarea style="padding-left: 0.5rem;" class="courseDescriptionContainer" id="feedbackText" placeholder="Enter your feedback:" name="" required></textarea>

                    <div class="closeContainer1">
                        <button class="closeButton1" onclick="submitFeedback()">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<div class="popUpMessageContainer1" id="successPopup1">
    <div class="subPopUpMessageContainer">
        <div class="imageContainer88">
            <img class="image88" src="{% static 'img/rb_3505.png' %}" alt="">
        </div>

        <div class="textContainer88" style="margin-bottom: 1rem;">
            <p>Grades and CET results cannot be greater than 100. Please enter valid CET results and Grade.</p>
        </div>
    </div>
</div>
    
<div class="popUpMessageContainer1" id="successPopup2">
    <div class="subPopUpMessageContainer">
        <div class="imageContainer88">
            <img class="image89" src="{% static 'img/rb_6326.png' %}" alt="">
        </div>

        <div class="textContainer88" style="margin-bottom: 1rem;">
            <p>Results still processing...</p>
        </div>
    </div>
</div>

<div class="popUpMessageContainer1" id="successPopup3" style="background-color: transparent;">
    <div class="subPopUpMessageContainer1">
        <div class="textContainer88" style="height: 20rem; align-items: center; justify-content: center; display: flex;">
            <p>Your responses and grades have been submitted successfully! This information will help improve your academic support.</p>
        </div>
    </div>
</div>

<div class="popUpMessageContainer1" id="successPopup4">
    <div class="subPopUpMessageContainer">
        <div class="imageContainer88">
            <img class="image88" src="{% static 'img/rb_3505.png' %}" alt="">
        </div>

        <div class="textContainer88" style="margin-bottom: 1rem;">
            <p>Please fill in both fields before submitting.</p>
        </div>
    </div>
</div>

<div class="popUpMessageContainer1" id="successPopup5">
    <div class="subPopUpMessageContainer">
        <div class="imageContainer88">
            <img class="image88" src="{% static 'img/rb_1749.png' %}" alt="">
        </div>

        <div class="textContainer88" style="margin-bottom: 1rem;">
            <p>Feedback submitted successfully!</p>
        </div>
    </div>
</div>

<div class="popUpMessageContainer1" id="successPopup">
    <div class="subPopUpMessageContainer">
        <div class="imageContainer88">
            <img class="image88" src="{% static 'img/rb_3505.png' %}" alt="">
        </div>

        <div class="textContainer88" style="margin-bottom: 1rem;">
            <p>Failed to submit feedback. Please try again.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let currentPage = 0;
    const questionsPerPage = 5;
    const questionContainers = document.querySelectorAll(".subQuestionContainer");
    const totalPages = Math.ceil(questionContainers.length / questionsPerPage);
    
    function showPage(page) {
        questionContainers.forEach((q, index) => {
            q.style.display = (index >= page * questionsPerPage && index < (page + 1) * questionsPerPage) ? "block" : "none";
        });
        
        document.getElementById("prevButton").style.display = page === 0 ? "none" : "inline-block";
        document.getElementById("nextButton").style.display = page === totalPages - 1 ? "none" : "inline-block";
        document.getElementById("doneButton").style.display = page === totalPages - 1 ? "inline-block" : "none";
        validateNextButton();
    }

    function validateNextButton() {
        const visibleQuestions = Array.from(questionContainers).slice(currentPage * questionsPerPage, (currentPage + 1) * questionsPerPage);
        let allAnswered = visibleQuestions.every(q => q.querySelector("input[type=radio]:checked"));
        document.getElementById("nextButton").disabled = !allAnswered;
    }

    document.addEventListener("change", validateNextButton);

    const buttonContainer = document.createElement("div");
    buttonContainer.style.textAlign = "center";
    buttonContainer.style.marginTop = "1rem";
    
    const prevButton = document.createElement("button");
    prevButton.innerText = "Back";
    prevButton.id = "prevButton";
    prevButton.style.margin = "0.5rem";
    prevButton.className = "submitButton";
    prevButton.style.display = "none";
    prevButton.addEventListener("click", function () {
        if (currentPage > 0) {
            currentPage--;
            showPage(currentPage);
        }
    });
    
    const nextButton = document.createElement("button");
    nextButton.innerText = "Next";
    nextButton.id = "nextButton";
    nextButton.className = "submitButton";
    nextButton.style.margin = "0.5rem";
    nextButton.disabled = true;
    nextButton.addEventListener("click", function () {
        if (currentPage < totalPages - 1) {
            currentPage++;
            showPage(currentPage);
        }
    });
    
    const doneButton = document.createElement("button");
    doneButton.innerText = "Done";
    doneButton.id = "doneButton";
    doneButton.style.display = "none";
    doneButton.style.margin = "0.5rem";
    doneButton.className = "submitButton";
    doneButton.setAttribute("onclick", "showPopup()")
    
    buttonContainer.appendChild(prevButton);
    buttonContainer.appendChild(nextButton);
    buttonContainer.appendChild(doneButton);
    document.querySelector(".questionContainer").appendChild(buttonContainer);
    
    showPage(currentPage);
});
</script>

    <script>
        function showPopup(popupId) {
    var popup = document.getElementById(popupId);
    popup.style.display = 'flex'; 

    setTimeout(() => {
        popup.style.display = 'none'; 
    }, 3000); // Show for 3 seconds
}
function showPopup1(popupId) {
    var popup = document.getElementById(popupId);
    popup.style.display = 'flex'; 

    setTimeout(() => {
        popup.style.display = 'none'; 
    }, 3000000); // Show for 3 seconds
}


var popup2 = document.getElementById(successPopup2);

document.getElementById('gradesForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const avgGrade = parseFloat(document.querySelector('.grades[name="avg_grade"]').value);
    const avgCet = parseFloat(document.querySelector('.grades[name="avg_cet"]').value);

    if (avgGrade > 100 || avgCet > 100) {
        showPopup('successPopup1'); // Grades/CET > 100 error
        return;
    }

    const form = this;
    showPopup1('successPopup2'); // Processing message

    fetch(form.action, {
        method: form.method,
        body: new FormData(form),
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            showPopup('successPopup3'); // Success
            setTimeout(() => {
                window.location.href = "{% url 'result' %}";
                popup2.style.display = 'none'; 
            }, 3000);
        } else {
            showPopup('successPopup4'); // Failure
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showPopup('successPopup5'); // Network error
    });
});


function submitFeedback() {
    const name = document.getElementById('feedbackName').value.trim();
    const feedback = document.getElementById('feedbackText').value.trim();

    if (!name || !feedback) {
        showPopup('successPopup4'); // Show error message
        return;
    }

    const data = new FormData();
    data.append('name', name);
    data.append('feedback', feedback);

    fetch('{% url "dashboard" %}', {
        method: 'POST',
        body: data,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (response.ok) {
            showPopup('successPopup5'); // Feedback submitted successfully
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showPopup('successPopup'); // Failed to submit
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showPopup('successPopup'); // Error submitting
    });
}


    function feedback() {
        var feedbackContainer = document.querySelector('.courseInfoContainer');
        feedbackContainer.style.display = feedbackContainer.style.display === 'none' ? 'block' : 'none';
    }
    </script>

    <script src="{% static 'js/exploreCourses.js' %}"></script>
    <script src="{% static 'js/dashboard.js' %}"></script>
</body>
</html>
